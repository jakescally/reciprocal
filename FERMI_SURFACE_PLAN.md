# Fermi Surface Viewer - Implementation Plan

## Status: Research Phase (Paused)

---

## Overview

The Fermi surface is the surface in reciprocal space separating occupied from unoccupied electronic states at zero temperature. Visualizing it requires:
1. Band energies on a dense 3D k-point grid
2. Isosurface extraction at E = E_Fermi (marching cubes algorithm)
3. Display within/relative to the Brillouin zone

---

## File Format Options

### Option 1: BXSF (XCrysden Format) - Well Documented

The **BXSF (Band-XSF)** format is the standard for Fermi surface data, used by XCrysden, FermiSurfer, and other tools.

**Structure:**
```
BEGIN_INFO
  Fermi Energy: 0.5432    # in Hartree
END_INFO

BEGIN_BLOCK_BANDGRID_3D
  band_energies
  BEGIN_BANDGRID_3D_fermi
    4                          # number of bands
    21 21 21                   # grid points (nx, ny, nz)
    0.0  0.0  0.0              # origin (Gamma point)
    1.0  0.0  0.0              # spanning vector 1 (reciprocal lattice units)
    0.0  1.0  0.0              # spanning vector 2
    0.0  0.0  1.0              # spanning vector 3
    BAND: 1
      [nx*ny*nz energy values in row-major C order]
    BAND: 2
      [nx*ny*nz energy values...]
    ...
  END_BANDGRID_3D
END_BLOCK_BANDGRID_3D
```

**Key points:**
- Energies in Hartree (convert to eV: multiply by 27.2114)
- Grid spans the **reciprocal unit cell**, not the BZ directly
- Data in row-major order (x outer, z inner loop)
- Origin must be at Gamma point

**Pros:** Standard format, single file, well-documented
**Cons:** Requires user to generate BXSF first (via XCrysden or other tools)

**Sources:**
- [XCrysden XSF Specification](http://web.mit.edu/xcrysden_v1.5.60/www/XCRYSDEN/doc/XSF.html)
- [XCrysden Fermi Surface Docs](http://www.xcrysden.org/doc/fermi.html)

---

### Option 2: Direct Wien2k Files - Needs More Research

**Files potentially needed:**
- `case.energy` / `case.energyso` - Eigenvalues from LAPW1
- `case.klist` - K-point grid information
- `case.struct` - Structure info (we already have CIF parsing)
- `case.scf` - Contains Fermi energy

**What we know about case.energy:**
- Generated by LAPW1 program
- Contains k-point info followed by eigenvalues
- Energies in Rydberg units (convert to eV: multiply by 13.6057)
- For parallel calculations, split into `case.energy_0`, `case.energy_1`, etc.
- Spin-polarized: `case.energyup` and `case.energydn`

**What we know about case.klist:**
- Columns: integer k-coordinates, divisor, weight
- K-point = (col2/col5, col3/col5, col4/col5)
- Weight depends on symmetry/multiplicity

**Challenges:**
- Fortran fixed-format files (need exact column positions)
- Parallel output needs merging
- Need to correlate k-points between files
- Less documentation available publicly

**TODO:**
- Find exact Fortran format statements from Wien2k source or user guide
- Consider asking user if they have example files to reverse-engineer

---

## Comparison: BXSF vs Direct Wien2k

| Aspect | BXSF | Direct Wien2k |
|--------|------|---------------|
| Parsing complexity | Low (text, self-contained) | Medium-High (Fortran formats, multiple files) |
| User workflow | Extra step to generate | Direct from calculation |
| Documentation | Good (public) | Limited (user guide needed) |
| All data in one place | Yes | No (need multiple files) |
| Grid already uniform | Yes | Maybe (depends on klist) |

**Recommendation:** Start with BXSF support, then add direct Wien2k parsing if needed.

---

## Technical Implementation

### Algorithm: Marching Cubes

To extract isosurface at E = E_Fermi:
1. For each cube in the 3D grid (8 vertices)
2. Determine which vertices are above/below E_F (256 possible cases)
3. Look up edge intersections from pre-computed table
4. Interpolate exact vertex positions on edges
5. Generate triangles for the surface

**Options:**
- Implement from scratch (full control, educational)
- Use Three.js MarchingCubes from examples
- Port an existing implementation

### Files to Create

```
src/lib/bxsfParser.ts           # Parse BXSF format
src/lib/marchingCubes.ts        # Isosurface extraction
src/components/FermiSurfacePage.tsx  # Main viewer (already stubbed by user)
```

### Reusable from Existing Code

- `brillouinZoneGeometry.ts` - BZ shapes, reciprocal lattice
- `brillouinZone.ts` - Bravais lattice detection, high-symmetry points
- Three.js patterns from `BrillouinZonePage.tsx`
- Orbit controls, lighting setup

---

## End User Features (Planned)

### Band Selection
- List all bands with energy range relative to E_F
- Highlight bands crossing Fermi level
- Toggle individual bands on/off
- Color each band differently

### Fermi Energy Adjustment
- Slider to shift E_F (explore electron/hole doping)
- Display current E_F value

### Visualization Options
- Show/hide Brillouin zone wireframe
- Show/hide high-symmetry points
- Surface opacity control
- Color modes: solid, by band, by velocity

### Interactivity
- Orbit/zoom/pan (same as BZ viewer)
- Click surface to show k-point coordinates

---

## UI Layout

Same floating glass card pattern as BZ viewer:
- Top-left: Material info, E_F value
- Top-right: Display options, E_F slider
- Bottom-left: Band list with toggles
- Bottom-right: Legend
- Full-screen 3D canvas behind

---

## Implementation Phases

### Phase 1: Parser & Data Structure
- Create `bxsfParser.ts`
- Extract Fermi energy, grid, reciprocal vectors, band data
- Unit tests with sample file

### Phase 2: Marching Cubes
- Implement isosurface extraction
- Generate Three.js BufferGeometry
- Handle multiple bands

### Phase 3: Basic Viewer
- Display isosurface with orbit controls
- Overlay BZ wireframe
- Basic band selection

### Phase 4: Controls & Polish
- Fermi energy slider
- Color options
- Performance optimization for large grids

---

## Open Questions

1. **Do your Wien2k workflows already produce BXSF files?** Or would direct parsing be more convenient?

2. **Typical grid sizes?** 20³, 30³, 50³? Affects performance needs.

3. **Spin-polarized calculations?** Need separate surfaces for up/down?

4. **Example files available?** Would help with format verification.

---

## Notes from User

- User prefers to avoid XCrysden dependency if possible
- User has already stubbed out `FermiSurfacePage.tsx` and updated App.tsx/ProjectPage.tsx
- Backend functions `listFermiSurfaces` added to projects.ts

---

## References

- [XCrysden XSF Format](http://web.mit.edu/xcrysden_v1.5.60/www/XCRYSDEN/doc/XSF.html)
- [XCrysden Fermi Surface](http://www.xcrysden.org/doc/fermi.html)
- [Wien2k Mailing List - Fermi Surface](https://www.mail-archive.com/wien@zeus.theochem.tuwien.ac.at/msg02057.html)
- [TRIQS DFTTools Wien2k Interface](https://triqs.github.io/dft_tools/latest/guide/conv_wien2k.html)
- [Wien2k User Guide](http://www.wien2k.at/reg_user/textbooks/usersguide.pdf) (registered users)
